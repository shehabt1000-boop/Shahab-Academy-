<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Shehab Academy - شات متقدم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* تنسيق عام */
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 20px;
      color: #111;
      display: flex;
      justify-content: center;
      height: 100vh;
      box-sizing: border-box;
    }

    /* شاشة تسجيل الدخول */
    #loginScreen {
      width: 100%; max-width: 400px;
      margin: auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      box-sizing: border-box;
    }
    #loginScreen input, #loginScreen select, #loginScreen button {
      width: 100%;
      margin: 8px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 16px;
    }
    #loginMsg {
      color: #d00;
      margin-bottom: 8px;
      min-height: 20px;
    }

    /* الواجهة الرئيسية */
    #app {
      width: 100%;
      max-width: 1000px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display: flex;
      height: 600px;
      box-sizing: border-box;
    }

    /* القائمة الجانبية */
    #sidebar {
      width: 280px;
      border-left: 1px solid #ddd;
      padding: 16px;
      overflow-y: auto;
      background: #fafafa;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #sidebar h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 20px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 6px;
    }

    #usersList div {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      position: relative;
    }

    /* علامة متصل */
    .online-dot {
      width: 12px; height: 12px;
      background: #2ecc71;
      border-radius: 50%;
      margin-left: auto;
      border: 2px solid #fafafa;
      box-sizing: content-box;
    }

    /* صورة الأفاتار */
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }

    /* القسم الرئيسي */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    /* رأس الشات */
    #chatHeader {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatTitle {
      user-select: none;
    }

    /* أزرار */
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #2d8cff;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
      transition: background 0.3s;
    }
    button:hover {
      background: #1a6fdd;
    }
    #logoutBtn {
      background: #e74c3c;
      transition: background 0.3s;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }

    /* قائمة الرسائل */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #f7f8fb;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }

    /* الرسالة */
    .msg {
      margin-bottom: 10px;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
      word-break: break-word;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    .msg .avatar {
      flex-shrink: 0;
    }
    .msgContent {
      flex: 1;
    }
    .msgHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .msgUser {
      font-weight: bold;
      user-select: text;
    }
    .msgTime {
      font-size: 12px;
      color: #666;
      margin-left: 8px;
      user-select: text;
    }
    .msgText {
      margin-top: 4px;
      white-space: pre-wrap;
      user-select: text;
    }
    .actions {
      margin-left: 10px;
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    .action-btn {
      cursor: pointer;
      font-size: 14px;
      color: #2d8cff;
      user-select: none;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .action-btn:hover {
      text-decoration: none;
      border-color: #2d8cff;
      background-color: #e6f0ff;
    }

    /* شريط الإدخال */
    #inputBar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #ddd;
      box-sizing: border-box;
      align-items: center;
    }
    #messageInput {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      resize: none;
      font-size: 16px;
      min-height: 40px;
      max-height: 80px;
      overflow-y: auto;
      box-sizing: border-box;
    }

    /* زر إيموجي */
    #emojiBtn {
      background: #ffca28;
      font-size: 20px;
      line-height: 1;
      width: 40px;
      height: 40px;
      border-radius: 6px;
      padding: 0;
      user-select: none;
    }
    #emojiBtn:hover {
      background: #fbc02d;
    }

    /* صندوق الإيموجي */
    #emojiPicker {
      position: absolute;
      bottom: 70px;
      right: 20px;
      width: 280px;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      display: none;
      padding: 10px;
      box-sizing: border-box;
      z-index: 100;
      user-select: none;
    }
    #emojiPicker .emoji-set {
      display: none;
    }
    #emojiPicker .emoji-set.active {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    #emojiPicker .emoji {
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      user-select: none;
      transition: background-color 0.2s;
    }
    #emojiPicker .emoji:hover {
      background-color: #e6f0ff;
    }
    #emojiPicker .emoji-sets-menu {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: center;
    }
    #emojiPicker .emoji-sets-menu button {
      flex: 1;
      padding: 6px 0;
      font-size: 18px;
      border: 1px solid #ddd;
      background: #fafafa;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    #emojiPicker .emoji-sets-menu button.active,
    #emojiPicker .emoji-sets-menu button:hover {
      background-color: #2d8cff;
      color: white;
      border-color: #2d8cff;
    }

    /* تحسين تجربة الهاتف - عرض عمودي */
    @media (max-width: 700px) {
      body {
        padding: 10px;
        height: auto;
      }
      #app {
        flex-direction: column;
        height: auto;
        max-width: 100%;
      }
      #sidebar {
        width: 100%;
        border-left: none;
        border-top: 1px solid #ddd;
        padding: 10px;
        height: 160px;
        overflow-x: auto;
        overflow-y: hidden;
        flex-direction: row;
      }
      #usersList div {
        flex-direction: column;
        align-items: center;
        font-size: 14px;
        padding: 4px 8px;
        border: none;
        min-width: 80px;
      }
      .online-dot {
        margin-left: 0;
        margin-top: 4px;
        border: 1.5px solid #fafafa;
      }
      #main {
        height: auto;
      }
      #messages {
        height: 400px;
        padding: 8px;
      }
      #inputBar {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen">
  <h2>تسجيل دخول Shehab Academy</h2>
  <input id="username" placeholder="اكتب اسمك" autocomplete="off" />
  <select id="gender">
    <option value="" disabled selected>اختر جنسك</option>
    <option value="male">ذكر</option>
    <option value="female">أنثى</option>
  </select>
  <button id="loginBtn">دخول الشات</button>
  <div id="loginMsg"></div>
</div>

<!-- واجهة الشات -->
<div id="app" style="display:none; position: relative;">
  <div id="main">
    <div id="chatHeader">
      <div id="chatTitle">Shehab Academy - الشات</div>
      <button id="logoutBtn">تسجيل خروج</button>
    </div>

    <div id="messages"></div>

    <div id="inputBar">
      <button id="emojiBtn" title="إضافة إيموجي">😊</button>
      <textarea id="messageInput" placeholder="اكتب رسالة..." rows="2"></textarea>
      <button id="sendBtn">إرسال</button>
    </div>
  </div>

  <div id="sidebar">
    <h3>المتصلون</h3>
    <div id="usersList"></div>
  </div>

  <!-- صندوق اختيار الإيموجي -->
  <div id="emojiPicker">
    <div class="emoji-sets-menu">
      <button class="emoji-set-btn active" data-set="smileys">🙂</button>
      <button class="emoji-set-btn" data-set="animals">🐱</button>
      <button class="emoji-set-btn" data-set="food">🍔</button>
    </div>
    <div class="emoji-set active" id="emoji-smileys">
      <!-- إيموجي ابتسامات -->
      😀 😃 😄 😁 😆 😅 😂 🤣 😊 😇 🙂 🙃 😉 😌 😍 🥰 😘 😗 😙 😚 😋 😛 😝 😜 🤪 🤨 🧐 🤓 😎 🥳 😏 😒 😞 😔 😟 😕 🙁 ☹️
    </div>
    <div class="emoji-set" id="emoji-animals">
      <!-- إيموجي حيوانات -->
      🐶 🐱 🐭 🐹 🐰 🦊 🐻 🐼 🐨 🐯 🦁 🐮 🐷 🐸 🐵 🦄 🐔 🦉 🦇 🐝 🐛 🦋 🐌 🐞 🦀 🐢 🦍 🦓 🦒 🐙 🐠 🐬
    </div>
    <div class="emoji-set" id="emoji-food">
      <!-- إيموجي طعام -->
      🍏 🍎 🍐 🍊 🍋 🍌 🍉 🍇 🍓 🥝 🍈 🍒 🍑 🥭 🍍 🥥 🥑 🍆 🥔 🥕 🌽 🌶️ 🥒 🥬 🥦 🧄 🧅 🍄 🥜 🌰 🍞 🥐 🥖
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // إعدادات Firebase (استبدل بالبيانات الخاصة بك)
  const firebaseConfig = {
    apiKey: "AIzaSyCmnF8hZ6WxvTtCuMUVdwBJsSC89ReDFTQ",
    authDomain: "chat-demo-1f31f.firebaseapp.com",
    databaseURL: "https://chat-demo-1f31f-default-rtdb.firebaseio.com",
    projectId: "chat-demo-1f31f",
    storageBucket: "chat-demo-1f31f.appspot.com",
    messagingSenderId: "875733022113",
    appId: "1:875733022113:web:a9d7d0bf77e4b3f366b5ee"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // عناصر HTML
  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');
  const usernameInput = document.getElementById('username');
  const genderSelect = document.getElementById('gender');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const usersListDiv = document.getElementById('usersList');
  const chatTitle = document.getElementById('chatTitle');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');

  // متغيرات المستخدم الحالي
  let currentUser = null;
  let currentUserKey = null;

  // تسجيل دخول
  loginBtn.addEventListener('click', () => {
    const name = usernameInput.value.trim();
    const gender = genderSelect.value;
    if (!name) {
      loginMsg.textContent = 'الرجاء كتابة اسم المستخدم';
      return;
    }
    if (!gender) {
      loginMsg.textContent = 'الرجاء اختيار الجنس';
      return;
    }
    loginMsg.textContent = '';

    currentUser = { name, gender };
    loginScreen.style.display = 'none';
    app.style.display = 'flex';

    registerUser();
    listenUsers();
    listenMessages();
  });

  // تسجيل خروج
  logoutBtn.addEventListener('click', () => {
    if (confirm('هل تريد تسجيل الخروج؟')) {
      if(currentUserKey){
        db.ref('users/' + currentUserKey).remove();
      }
      currentUser = null;
      currentUserKey = null;
      loginScreen.style.display = 'block';
      app.style.display = 'none';
      messagesDiv.innerHTML = '';
      usersListDiv.innerHTML = '';
      usernameInput.value = '';
      genderSelect.value = '';
      db.ref('messages').off();
      db.ref('users').off();
      emojiPicker.style.display = 'none';
    }
  });

  // إرسال رسالة
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    const message = {
      username: currentUser.name,
      gender: currentUser.gender,
      message: text,
      timestamp: Date.now()
    };
    db.ref('messages').push(message);
    messageInput.value = '';
    scrollBottom();
  }

  // الاستماع للرسائل
  function listenMessages() {
    messagesDiv.innerHTML = '';
    db.ref('messages').limitToLast(1000).off();

    db.ref('messages').limitToLast(1000).on('child_added', snapshot => {
      const msg = snapshot.val();
      const id = snapshot.key;
      addMessage(msg, id);
      scrollBottom();
    });

    db.ref('messages').on('child_changed', snapshot => {
      const msg = snapshot.val();
      const id = snapshot.key;
      updateMessage(msg, id);
    });

    db.ref('messages').on('child_removed', snapshot => {
      const id = snapshot.key;
      removeMessage(id);
    });
  }

  function addMessage(m, id) {
    if(document.getElementById('msg-' + id)) return
